name: Update LIFX from PurpleAir

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes
  workflow_dispatch:
    inputs:
      color:
        description: "Manual hex color override (ex: #FF0000). Leave blank to use PurpleAir."
        required: false
        default: ""

jobs:
  update-light:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install requests

      - name: Run script
        env:
          LIFX_API_KEY: ${{ secrets.LIFX_API_KEY }}
          PURPLEAIR_API_KEY: ${{ secrets.PURPLEAIR_API_KEY }}
          PA_SENSORS_CSV_URL: "https://raw.githubusercontent.com/DKevinM/AB_datapull/data/AB_PA_sensors.csv"         
        run: |
          if [ -n "${{ github.event.inputs.color }}" ]; then
            echo "Manual override color = ${{ github.event.inputs.color }}"
            python update_light_pa.py --color "${{ github.event.inputs.color }}"
          else
            echo "Scheduled run: using PurpleAir data"
            python update_light_pa.py
          fi

      - name: Commit JSON to repo
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/purpleair_light_status.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update PurpleAir light status JSON"
            git push
          fi
