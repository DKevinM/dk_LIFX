<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PurpleAir – Corrected PM2.5 Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1120;
      color: #e5e7eb;
    }

    #map {
      height: 100vh;
      width: 100vw;
    }

    .info-box {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      font-size: 0.85rem;
      line-height: 1.3;
    }

    .info-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 0.95rem;
    }

    .info-label {
      font-weight: 500;
      color: #9ca3af;
    }

    .info-main {
      margin-top: 0.25rem;
      font-size: 0.95rem;
    }

    .info-small {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }

    .aqhi-color-box {
      border-radius: 0.35rem;
      border: 1px solid #020617;
    }

    .resource-links {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid rgba(148,163,184,0.25);
    }
    
    .resource-links a {
      display: block;
      color: #93c5fd;
      text-decoration: none;
      font-size: 0.8rem;
      margin-top: 4px;
    }
    
    .resource-links a:hover {
      text-decoration: underline;
    }
    
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // --- Helpers -----------------------------------------------------

    function pmToColor(v) {
      // Same breaks as your get_pa_color()
      if (v == null || isNaN(v)) return "#D3D3D3";    
      if (v > 100) return "#640100";
      if (v > 90) return "#9a0100";
      if (v > 80)  return "#cc0001";
      if (v > 70)  return "#fe0002";
      if (v > 60)  return "#fd6866";
      if (v > 50)  return "#ff9835";
      if (v > 40)  return "#ffcb00";
      if (v > 30)  return "#fffe03";
      if (v > 20)  return "#016797";
      if (v > 10)  return "#0099cb";
      if (v > 0)  return "#01cbff";
      return "#D3D3D3";
    }

    function toEdmontonLocal(isoString) {
      if (!isoString) return "(unknown)";
      try {
        const d = new Date(isoString);
        // Force Edmonton timezone regardless of user location
        return d.toLocaleString("en-CA", {
          timeZone: "America/Edmonton",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      } catch (e) {
        return isoString;
      }
    }

    

    

    // --- Main --------------------------------------------------------

    async function initMap() {
      // Base map
      const map = L.map("map").setView([53.5, -113.5], 5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Info control (top-left)
      const info = L.control({ position: "topleft" });

      info.onAdd = function() {
        this._div = L.DomUtil.create("div", "info-box");
        this.update();
        return this._div;
      };


      info.update = function(props) {
      
        // ---------- INITIAL / LOADING STATE ----------
        if (!props) {
          this._div.innerHTML = `
            <div class="info-title">PurpleAir – Corrected PM2.5</div>
      
            <div style="display:flex; align-items:center; margin-top:8px;">
              <div class="aqhi-color-box"
                   style="background:#9CA3AF; width:60px; height:40px;">
              </div>
      
              <div style="margin-left:10px; font-size:15px; font-weight:600;">
                estimated AQHI: —
              </div>
            </div>
      
            <div class="info-small" style="margin-top:10px;">
              Loading latest data…
            </div>
      
            <div class="resource-links">
              <div class="info-label">External Resources</div>
              <a href="https://firesmoke.ca/forecasts/current/" target="_blank">
                FireSmoke Canada – Current Forecast
              </a>
              <a href="https://eer.cmc.ec.gc.ca/mandats/AutoSim/ops/Fire_CA_HRDPS_CWFIS/latest/Canada/latest/img/Canada/anim.html" target="_blank">
                ECCC Fire & Smoke HRDPS Animation
              </a>
            </div>
          `;
          return;
        }
      
        // ---------- DATA AVAILABLE ----------
        const { generatedAtLocal, avgPm, nSensors } = props;
      
        const hasAvg = typeof avgPm === "number";
        const boxColor = hasAvg ? pmToColor(avgPm) : "#9CA3AF";
      
        let estAQHI = "—";
        if (hasAvg && !isNaN(avgPm)) {
          let val = Math.floor(avgPm / 10) + 1;
          estAQHI = val > 10 ? "10+" : val;
        }
      
        this._div.innerHTML = `
          <div class="info-title">PurpleAir – Corrected PM2.5</div>
      
          <div style="display:flex; align-items:center; margin-top:8px;">
            <div class="aqhi-color-box"
                 style="background:${boxColor}; width:60px; height:40px;">
            </div>
      
            <div style="margin-left:10px; font-size:15px; font-weight:600;">
              estimated AQHI: ${estAQHI}
            </div>
          </div>
      
          <div class="info-label" style="margin-top:10px;">Generated:</div>
          <div>${generatedAtLocal}</div>
      
          <div class="info-label" style="margin-top:10px;">Average PM2.5 (corrected):</div>
          <div>${hasAvg ? avgPm.toFixed(1) + " µg/m³" : "(n/a)"}</div>
      
          <div class="info-small" style="margin-top:6px;">
            ${nSensors} sensor${nSensors === 1 ? "" : "s"} averaged
          </div>
      
          <div class="resource-links">
            <div class="info-label">External Resources</div>
            <a href="https://firesmoke.ca/forecasts/current/" target="_blank">
              FireSmoke Canada – Current Forecast
            </a>
            <a href="https://eer.cmc.ec.gc.ca/mandats/AutoSim/ops/Fire_CA_HRDPS_CWFIS/latest/Canada/latest/img/Canada/anim.html" target="_blank">
              ECCC Fire & Smoke HRDPS Animation
            </a>
          </div>
        `;
      };
      


      info.addTo(map);

      // Load JSON
      try {
        const resp = await fetch("data/purpleair_light_status.json?cb=" + Date.now());
        if (!resp.ok) {
          info.update({
            generatedAtLocal: "(no JSON)",
            avgPm: null,
            nSensors: 0
          });
          console.error("Failed to fetch JSON:", resp.status, await resp.text());
          return;
        }

        const data = await resp.json();

        const light = data.light || {};
        const sensors = Array.isArray(data.sensors) ? data.sensors : [];

        const avgPm = typeof light.used_pm25_corr === "number"
          ? light.used_pm25_corr
          : null;

        const nSensors = Array.isArray(light.used_sensor_indices)
          ? light.used_sensor_indices.length
          : 0;

        const generatedAtLocal = toEdmontonLocal(data.generated_at_utc);

        info.update({
          generatedAtLocal,
          avgPm,
          nSensors
        });

        // Plot sensors
        const markers = [];
        sensors.forEach(s => {
          const lat = s.latitude;
          const lon = s.longitude;
          if (lat == null || lon == null) return;

          const pm = (typeof s.pm25_corr === "number") ? s.pm25_corr : null;
          const color = pmToColor(pm);
          const name = s.name || `Sensor ${s.sensor_index}`;
          const lastSeenLocal = toEdmontonLocal(s.last_seen_iso_utc);

          const marker = L.circleMarker([lat, lon], {
            radius: 10,
            color: "#111827",
            weight: 1,
            fillColor: color,
            fillOpacity: 0.9
          });

          // Hover tooltip: name + corrected PM
          const popupHtml = `
            <div><strong>${name}</strong></div>
            <div>Sensor ID: ${s.sensor_index ?? "(unknown)"}</div>
            <div>Corrected PM2.5: ${
              pm == null ? "n/a" : pm.toFixed(2) + " µg/m³"
            }</div>
            <div>Last seen: ${lastSeenLocal}</div>
          
            <hr style="margin:6px 0">
          
            <a href="/AQHI.forecast/history/sensor_compare.html"
               target="_blank"
               style="color:#60a5fa; text-decoration:none; font-size:0.8rem;">
               Click here for sensor history
            </a>
          `;

          marker.bindPopup(popupHtml);

          marker.addTo(map);
          markers.push(marker);
        });

        if (markers.length > 0) {
          const group = L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.4));
        }

      } catch (err) {
        console.error("Error loading or parsing JSON:", err);
        info.update({
          generatedAtLocal: "(error loading JSON)",
          avgPm: null,
          nSensors: 0
        });
      }
    }

    window.addEventListener("load", initMap);
  </script>
</body>
</html>
